# Проектная работа: Биллинг
Репозиторий с работой [graduate_work](https://github.com/AlexeyBely/graduate_work)

Данный сервис решает две основные задачи:
1. Позволяет производить оплату за просмотр приоритетных фильмов.
2. Обеспечивает доступ отдела маркетинга к тарифам, скидкам, промо-кодам.
   
### Функциональные требования

1. Доступ к приоритетным фильмам осуществляется через роли (тарифы) пользователей.
2. Требования к тарифным планам:
    - тариф расчитывается с учетом персональной скидки пользователя;
    - тариф расчитывается с учетом скидки от количества месяцев;
    - промо-коды не привязаны к пользователю, общая скидка не суммируется;
    - возврат денежных средств возможен не более часа с момента оплаты;
    - после окончания тарифа предоставить доступ к фильмам в течении 2 дней
2. Предусмотреть хранилище для:
    - статуса оплаты пользователей;
    - скидок для каждого пользователя;
    - скидок от количества приобретенных месяцев;
    - промо-кодов;
    - тарифа приоритетных фильмов.
3. Cервис должен иметь API интерфейс, эндпоинты:
    - для выставления счета по выбранному тарифу; 
    - перенаправление в платежную систему для оплаты;
    - отмена оплаты и возврат денег до 1 часа с момента оплаты;
    - подтверждение оплаты;
    - информация об оплате пользователя.
4. Предусмотреть планировшик с функциями:
    - периодическая проверка оплаты (в отсутсвие подтверждения через API);
    - проверка окончания срока по тарифному плану.
5. Взаимодействие с сервисом нотификации:
    - сообщать об оплате тарифного плана;
    - сообщать об окончании тарифного плана;
    - сообщать об блокировки тарифного плана (после 2 дней окончания).
6. Предусмотреть админ-панель с функциями:
    - просмотр оплаты пользователей;
    - создание/изменение тарифного плана;
    - изменение стоимости тарифных планов;
    - просмотр/изменение скидки по каждому пользователю;
    - просмотр/изменение скидки от количества месяцев;
    - создание/удаление промо-кодов. 
     
### Системная архитектура
       
![Сжема сервиса биллинга](./schemas/billing_system_schema.png)
     
### Диаграмма последовательности оплаты
       
![Диаграмма последовательности](./schemas/billing_sequence_schema.png)
      
### Схема базы данных psql-billing
     
![Схема базы данных](./schemas/schema_db.png)
     
### Описание работы сервиса
    
Для создания и редактирования тарифных планов, скидок и промокодов создана отдельная схема marketing в БД. Доступ
осуществляется через админ-панель. При создании тарифного плана в админ-панели через gRPC создаётся роль в сервисе авторизации, котороая будет использоваться для доступа пользователей.   
Для работы системы оплаты и контроля подписки (окончания подписки) используются три связанные таблицы customer, payment, privileged_role в схеме billing. Таблица customer служит для связки ID пользователя (user_id) сервиса авторизации и ID клиента биллинг сервиса, user_id передается в jvt-токене. Email используется для идентификации клиента в админ-панели, передается по gRPC от сервиса авторизации при создании первого платежа. Таблица payment содержит все данные по платежу, включая скидки на момент оплаты, ID платежей от облачной системы платежей. Таблица privileged_role содержит подписку на тарифный план (роль в системе авторизации), дату окончания подписки. Дата окончания и статус подписки формируется при оплате (отмене оплаты) платежа. Для синхронизации ролей в биллинг сервисе и сервисе авторизации используется gRPC.    
Подтверждение оплаты (отмены оплаты) осуществляется двумя путями. Первый, через веб-хук, далее задача передается обработчику-воркеру через брокер сообщений. Второй вариант через запуск переодических задач. Окончание тарифного плана проверяется периодической задачей с большим интервалом, к примеру раз в сутки.
Сообщения о подписке, окончания подписки и блокировке подписки передаются в сервис нотификации с помощью gRPC. 

### Подготовка и запуск проекта

1. Задайте переменные окружения в файле `.env` в корне проекта (пример в файле `.env.sample`).
2. Запустите создание контейнеров с помощью команды:
```commandline
docker-compose up
```
3. Создайте таблицы базы данных и суперпользователя админ-панели. Для этого зайдите в приложение admin-billing
```commandline
docker exec -it admin-billing bash
```
Запуск миграций для создания таблиц БД
```commandline
python manage.py migrate
```
Создание суперпользователя
```commandline
python manage.py createsuperuser
```
Документацию по API можно найти по адресу [http://127.0.0.1/billing/api/openapi]()
    
Админ-панель доступна по адресу [http://127.0.0.1/admin-billing/]()

### Использованные технологии   
    
- FastAPI
- Django
- Celery
- RabbitMQ
- PSQL
- gRPC

### Над проектом работали
- Алексей Белоглазов [@AlexeyBely](https://github.com/AlexeyBely)